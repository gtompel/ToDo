# Конфигурация nginx для двух Next.js приложений

# Первый сервер: arm-list.oit.int (порт 3000)
server {
    server_name arm-list.oit.int;

    location / {
        proxy_pass http://172.16.6.57:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location /api/tasks/events {
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;

        proxy_read_timeout 1h;
        proxy_send_timeout 1h;

        proxy_buffering off;
        proxy_request_buffering off;
        proxy_cache off;

        gzip off;
        chunked_transfer_encoding off;
        add_header X-Accel-Buffering no;

        proxy_pass http://172.16.6.57:3000;
    }

    location /api/ {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        proxy_pass http://172.16.6.57:3000;
    }
}

# Второй сервер: todo.oit.int (порт 3001)
# ВАЖНО: приложение Next.js должно быть запущено на 127.0.0.1:3001
server {
    server_name todo.oit.int;

    client_max_body_size 50M;

    # SSE stream для уведомлений
    location /api/notifications/stream {
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;

        proxy_read_timeout 1h;
        proxy_send_timeout 1h;

        proxy_buffering off;
        proxy_request_buffering off;
        proxy_cache off;

        gzip off;
        chunked_transfer_encoding off;
        add_header X-Accel-Buffering no;

        proxy_pass http://127.0.0.1:3001;
    }

    # API (все остальные)
    location /api/ {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        proxy_pass http://127.0.0.1:3001;
    }

    # Отдача загруженных файлов напрямую
    location /uploads/ {
        alias /home/locadmin/DDproj/Portal/public/uploads/;
        access_log off;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Всё остальное — Next.js (SSR + статика)
    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
