# ITSM Project

## Описание
Веб-приложение для управления инцидентами, запросами, изменениями и пользователями на базе Next.js 15, Prisma, PostgreSQL.

---

## 1. Структура проекта и папок

### **app/**
- **Назначение:** Главная точка входа для страниц и API-роутов (Next.js App Router).
- **Страницы**: Каждая папка — отдельный маршрут. Например, `app/incidents/` содержит:
  - `page.tsx` — список инцидентов (серверный компонент, получает данные через Prisma).
  - `new/page.tsx` — форма создания (клиентский компонент, использует useState/useEffect, отправляет данные через fetch).
  - `[id]/page.tsx` — просмотр/редактирование (динамический роут, получает id через params).
- **API**: Внутри `app/api/` — подпапки для каждой сущности (users, incidents, requests и т.д.), в каждой подпапке — отдельные файлы для CRUD, смены статуса, назначения и т.д.
- **Особенности реализации**:
  - Используется file-based routing Next.js: структура папок = структура URL.
  - Для динамических роутов используются квадратные скобки: `[id]/page.tsx`.
  - Для вложенных действий (например, смена статуса) — подпапки: `status/route.ts`.

### **components/**
- **Назначение:** Все переиспользуемые UI-компоненты.
- **Структура:**
  - **ui/** — атомарные компоненты (Button, Input, Card, Select, Alert, Checkbox и др.), написаны с использованием Tailwind, forwardRef, поддерживают className для кастомизации.
  - **header.tsx, sidebar.tsx** — layout-компоненты.
  - **notification-bell.tsx, notification-center.tsx** — работа с уведомлениями.
  - **user-form.tsx, user-profile-card.tsx** — формы и карточки пользователя.
- **Паттерны:**
  - Все компоненты максимально атомарны, не содержат бизнес-логики.
  - Для сложных форм используются кастомные хуки и схемы валидации (zod).
  - Для стилизации — Tailwind + возможность расширения через className.

### **hooks/**
- **Назначение:** Кастомные React-хуки для повторного использования логики.
- **Примеры:**
  - **use-user.tsx** — загрузка, обновление пользователя, хранит состояния loading/error/user, использует useCallback для мемоизации.
  - **use-toast.ts** — глобальные уведомления, реализует паттерн pub/sub, хранит очередь уведомлений, позволяет вызывать toast из любого места.
  - **use-mobile.tsx** — определяет, мобильное ли устройство, для адаптивного UI.
- **Реализация:** Все хуки используют только React API, не зависят от внешних библиотек (кроме zod для валидации).

### **lib/**
- **Назначение:** Бизнес-логика, работа с БД, валидация, вспомогательные функции.
- **Структура:**
  - **actions/** — отдельный файл для каждой сущности (users, incidents, requests и т.д.), реализует CRUD, дополнительные действия (смена статуса, назначение и т.д.).
    - Пример: `createIncident(formData, userId)` — получает данные из формы, валидирует, создает запись через Prisma, возвращает результат.
  - **auth.ts** — функции для аутентификации (getCurrentUser, login, logout), используют JWT, хранят токен в cookie.
  - **prisma.ts** — инициализация Prisma Client, singleton-паттерн для предотвращения повторного создания клиента.
  - **utils.ts** — вспомогательные функции (например, fetchWithTimeout — обертка над fetch с таймаутом и обработкой ошибок).
  - **validation/** — схемы валидации (zod), для каждого типа данных отдельная схема (user, incident и т.д.).
- **Паттерны:**
  - Вся бизнес-логика вынесена из компонентов, чтобы облегчить тестирование и повторное использование.
  - Для валидации всегда используется zod, ошибки пробрасываются наверх для отображения пользователю.

### **prisma/**
- **Назначение:** Работа с базой данных.
- **schema.prisma** — описание моделей, связей, индексов.
- **migrations/** — миграции, создаются автоматически через Prisma CLI.
- **seed.ts** — сидирование тестовыми данными (создание пользователей, инцидентов и т.д.).
- **Паттерны:** 
  - Все связи между сущностями явно описаны (relation).
  - Для каждого изменения структуры БД — отдельная миграция.

### **public/**
- **Назначение:** Статические файлы (картинки, favicon, загружаемые файлы).
- **Особенности:** Все, что лежит в public, доступно по прямому URL.

### **styles/**
- **Назначение:** Tailwind CSS, глобальные стили.
- **globals.css** — базовые стили, кастомизация Tailwind.
- **tailwind.config.ts** — настройка тем, кастомных цветов, брейкпоинтов.

### **scripts/**
- **Назначение:** SQL-скрипты для инициализации и наполнения БД.
- **Использование:** Обычно запускаются вручную или через npm-скрипты.

---

## 2. Роуты: реализация, паттерны, обработка ошибок

### **Страницы (app/)**
- **CRUD:** Для каждой сущности реализованы страницы списка, создания, просмотра/редактирования.
- **Фильтрация:** Используется query-параметры или фильтрация на сервере через Prisma.
- **Авторизация:** Проверка пользователя через getCurrentUser (lib/auth.ts), если не авторизован — редирект на /login.
- **Обработка ошибок:** Все асинхронные операции обернуты в try/catch, ошибки отображаются пользователю через UI (toast, alert).

### **API (app/api/)**
- **REST:** Каждый endpoint реализует отдельное действие (GET, POST, PATCH, DELETE).
- **Структура:** Для сложных действий (смена статуса, назначение) — отдельные подпапки.
- **Валидация:** Все входные данные валидируются через zod (lib/validation).
- **Ответы:** Всегда возвращается JSON с полем success/error, подробное сообщение об ошибке.
- **Авторизация:** Проверка токена пользователя, если нет — 401.
- **Пример реализации:**
  ```ts
  // app/api/incidents/route.ts
  export async function POST(req) {
    const data = await req.json();
    const parsed = incidentSchema.safeParse(data);
    if (!parsed.success) return Response.json({ error: parsed.error }, { status: 400 });
    // ... создание инцидента
    return Response.json({ success: true });
  }
  ```

---

## 3. Компоненты: паттерны, стилизация, взаимодействие

- **Атомарность:** Каждый компонент делает только одну вещь (Button, Input, Card и т.д.).
- **Переиспользование:** Все компоненты поддерживают className, можно расширять стили.
- **Формы:** Для сложных форм используется zod для валидации, ошибки отображаются рядом с полем.
- **Стилизация:** Tailwind, поддержка тем (light/dark), кастомизация через tailwind.config.ts.
- **Интерактивность:** Для интерактивных элементов (кнопки, чекбоксы) используются forwardRef, чтобы поддерживать работу с формами и accessibility.
- **Пример:**
  ```tsx
  <form onSubmit={handleSubmit}>
    <Input value={form.email} onChange={...} />
    <Button type="submit">Сохранить</Button>
  </form>
  ```

---

## 4. Хуки: назначение, интеграция, примеры

- **useUser:** Получение и обновление пользователя, хранит состояния, используется в профиле, списках, формах.
- **useToast:** Глобальные уведомления, можно вызвать из любого места, поддерживает очередь, автоудаление.
- **useMobile:** Определяет мобильное устройство, позволяет адаптировать UI.
- **Интеграция:** Все хуки импортируются и используются в компонентах, не требуют дополнительной настройки.

---

## 5. Бизнес-логика и утилиты

- **actions:** Для каждой сущности отдельный файл, реализует все действия (CRUD, смена статуса, назначение и т.д.).
- **Валидация:** Всегда через zod, ошибки пробрасываются наверх.
- **Работа с БД:** Через Prisma, все запросы асинхронные, обернуты в try/catch.
- **Обработка ошибок:** Все ошибки логируются, пользователю возвращается понятное сообщение.
- **Пример:**
  ```ts
  export async function createRequest(formData, userId) {
    // ... валидация
    try {
      await prisma.request.create({ ... });
      return { success: true };
    } catch (e) {
      return { error: 'Ошибка создания запроса' };
    }
  }
  ```

---

## 6. Работа с БД

- **Миграции:** Через Prisma CLI (`npx prisma migrate dev`), каждая миграция — отдельная папка.
- **Сиды:** seed.ts — наполнение тестовыми данными, можно запускать через `npx prisma db seed`.
- **Модели:** Описаны в schema.prisma, поддерживают связи (relation), индексы, уникальные поля.
- **Пример модели:**
  ```prisma
  model Incident {
    id        String   @id @default(uuid())
    title     String
    status    String
    createdAt DateTime @default(now())
    // ...
  }
  ```

---

## 7. Стилизация

- **Tailwind:** Используется для всех компонентов, кастомизация через tailwind.config.ts.
- **Темы:** Поддержка светлой/тёмной темы, переключение через UI.
- **Глобальные стили:** В файле styles/globals.css.

---

## 8. Тестирование и расширение

- **Добавление новых фич:** Следуйте паттернам — новая сущность = новая папка в app, actions, API, компоненты, схема в БД.
- **Тестирование:** Для бизнес-логики можно писать unit-тесты (например, через jest).
- **CI/CD:** Можно настроить через GitHub Actions — запускать тесты, миграции, деплой.

---

## 9. Примеры кода и best practices

- **Асинхронные операции:**
  ```ts
  try {
    const res = await fetch(...);
    if (!res.ok) throw new Error('Ошибка');
    const data = await res.json();
  } catch (e) {
    // обработка ошибки
  }
  ```
- **Валидация через zod:**
  ```ts
  const schema = z.object({ ... });
  const parsed = schema.safeParse(data);
  if (!parsed.success) return { error: parsed.error };
  ```
- **Работа с формами:**
  ```tsx
  <form onSubmit={handleSubmit}>
    <Input ... />
    <Button ... />
  </form>
  ```

---

## Как добавить новую сущность (пример)

1. В папке `app/` создаёте папку с именем сущности (например, `assets/`).
2. Внутри создаёте:
   - `page.tsx` — список.
   - `new/page.tsx` — создание.
   - `[id]/page.tsx` — детали.
3. В `app/api/` создаёте аналогичную структуру для API.
4. В `lib/actions/` добавляете файл с бизнес-логикой.
5. В `components/` — формы, карточки, списки для UI.
6. В `prisma/schema.prisma` — добавляете модель, делаете миграцию.

---

## Рекомендации для нового разработчика

- Всегда используйте camelCase.
- Разбивайте большие компоненты на мелкие.
- Все асинхронные операции — через try/catch.
- Для валидации используйте zod.
- Для fetch используйте обработку ошибок и таймауты (см. lib/utils.ts).
- Для новых API-роутов используйте REST-структуру (CRUD + отдельные endpoints для статусов/приоритетов).
- Для UI используйте компоненты из `components/ui/` и переиспользуйте существующие решения.

---

## Запуск проекта

1. Установите зависимости:
   ```bash
   npm install
   ```
2. Настройте переменные окружения в `.env` (см. пример ниже).
3. Примените миграции:
   ```bash
   npx prisma migrate dev
   ```
4. Запустите dev-сервер:
   ```bash
   npm run dev
   ```

### Пример .env
```
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
JWT_SECRET=your-secret-key
```

---

## Документация
- [Next.js](https://nextjs.org/docs)
- [Prisma](https://www.prisma.io/docs)
- [Zod](https://zod.dev/)

---
Если есть вопросы — пишите в issues! 